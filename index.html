<!DOCTYPE html>
<html>
  <head>
    <style>
      #plot-wrapper {
        display: flex;
        width: 100%;
        gap: 20px;
      }
      svg {
        border: 1px solid #ccc;
        flex: 1;
        height: 450px;
        width: 100%;
      }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/d3-lasso@1.0.0/build/d3-lasso.min.js"></script>
  </head>
  <body>
    <label for="color">Choose color: </label>
    <input type="color" id="color" value="#ff0000" />
    <span>(Cmd-click for additive)</span>

    <div id="color-palette" style="margin-top: 8px">
      <!-- swatches inserted below -->
    </div>

    <div id="plot-wrapper">
      <svg id="plot1"></svg>
      <svg id="plot2"></svg>
      <svg id="plot3"></svg>
    </div>

    <div
      id="label-counts"
      style="margin-top: 12px; font-family: sans-serif"
    ></div>

    <script>
      let convo_slug = "jean-lou";
      Promise.all([
        d3.json(`data/${convo_slug}/pca.json`),
        d3.json(`data/${convo_slug}/pacmap.json`),
        d3.json(`data/${convo_slug}/localmap.json`),
      ]).then(([X1, X2, X3]) => {
        const N = X1.length;

        const colorByIndex = Array(N).fill(null);
        let selectedIndicesGlobal = new Set();

        const width = 450,
          height = 450;
        let isShiftPressed = false;

        function getScales(X, width, height, padding = 40) {
          const xExtent = d3.extent(X, (d) => d[0]);
          const yExtent = d3.extent(X, (d) => d[1]);

          return {
            x: d3
              .scaleLinear()
              .domain(xExtent)
              .range([padding, width - padding]),
            y: d3
              .scaleLinear()
              .domain(yExtent)
              .range([height - padding, padding]), // flip Y for SVG coords
          };
        }

        const presetColors = [
          "#ff0000",
          "#00cc00",
          "#0066ff",
          "#ff9900",
          "#cc00cc",
        ];

        function renderColorPalette() {
          const container = document.getElementById("color-palette");
          container.innerHTML = presetColors
            .map(
              (color) => `
        <span 
          style="
            display:inline-block;
            width:20px; height:20px;
            background:${color};
            border:1px solid #888;
            margin-right:5px;
            cursor:pointer;
          "
          title="${color}"
          onclick="document.getElementById('color').value = '${color}'"
        ></span>`
            )
            .join("");
        }

        function updateLabelCounts() {
          const counts = {};
          for (const color of colorByIndex) {
            if (color) {
              counts[color] = (counts[color] || 0) + 1;
            }
          }

          const container = document.getElementById("label-counts");
          const entries = Object.entries(counts)
            .map(
              ([color, count]) =>
                `<span style="margin-right: 12px;">
          <span style="display:inline-block; width:14px; height:14px; background:${color}; border:1px solid #aaa; margin-right:5px; vertical-align:middle;"></span>
          ${count}
        </span>`
            )
            .join("");

          container.innerHTML = entries || "(No selections yet)";
        }

        function renderPlot(svgId, data, title) {
          const svg = d3.select(svgId);
          const scales = getScales(data, width, height);

          svg.selectAll("*").remove(); // Clear

          // ðŸ‘‰ Add title at the top center
          svg
            .append("text")
            .attr("x", width / 2)
            .attr("y", 25)
            .attr("text-anchor", "middle")
            .attr("font-size", "16px")
            .attr("font-weight", "bold")
            .text(title);

          // Draw points
          svg
            .selectAll("circle")
            .data(data)
            .enter()
            .append("circle")
            .attr("cx", (d) => scales.x(d[0]))
            .attr("cy", (d) => scales.y(d[1]))
            .attr("r", 5)
            .attr("fill-opacity", 0.3)
            .attr("fill", (_, i) => colorByIndex[i] || "rgba(0,0,0,0.5)");

          // Brush for selection
          const brush = d3
            .brush()
            .extent([
              [0, 0],
              [width, height],
            ])
            .on("end", (event) => {
              if (!event.selection) return;
              const [[x0, y0], [x1, y1]] = event.selection;
              const selectedColor = document.getElementById("color").value;

              const pointsInBrushBounds = [];

              svg.selectAll("circle").each(function (d, i) {
                const cx = scales.x(d[0]);
                const cy = scales.y(d[1]);
                if (x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1) {
                  pointsInBrushBounds.push(i);
                }
              });

              const additive = isShiftPressed || event.sourceEvent?.metaKey;

              // Reset everything if not additive
              if (!additive) {
                colorByIndex.fill(null);
                selectedIndicesGlobal.clear();
              }

              // Only update points that are *currently in bounds* of brush
              pointsInBrushBounds.forEach((i) => {
                colorByIndex[i] = selectedColor;
                selectedIndicesGlobal.add(i); // optional: for visual feedback later
              });

              svg.select(".brush").call(brush.move, null); // Clear brush

              renderPlot("#plot1", X1, "PCA projection");
              renderPlot("#plot2", X2, "PaCMAP projection");
              renderPlot("#plot3", X3, "LocalMAP projection");

              updateLabelCounts();
            });

          svg.append("g").call(brush);
        }

        renderPlot("#plot1", X1, "PCA projection");
        renderPlot("#plot2", X2, "PaCMAP projection");
        renderPlot("#plot3", X3, "LocalMAP projection");

        updateLabelCounts();
        renderColorPalette();

        window.addEventListener("keydown", (e) => {
          if (e.key === "Shift") isShiftPressed = true;
        });

        window.addEventListener("keyup", (e) => {
          if (e.key === "Shift") isShiftPressed = false;
        });
      });
    </script>
  </body>
</html>
